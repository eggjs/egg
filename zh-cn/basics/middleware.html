<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <title>中间件 - 为企业级框架和应用而生</title>
<meta charset="utf-8">
<meta name="description" content="">
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="icon" href="/images/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/css/index.css">

</head>
<body>
  <div class="nav" >
  <header>
    <a href="/zh-cn/" class="nav-logo" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li><a href="/zh-cn/intro/" alt="指南">指南</a></li><li><a href="/zh-cn/tutorials/index.html" alt="教程">教程</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="插件">插件</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="发布日志">发布日志</a></li>
      <!--
      <li class="translations">
        <a class="nav-link">切换语言</a>
        <span class="arrow"></span>
        <ul class="dropdown-content">
          <li><a href="/">中文</a></li>
          <li><a href="/">English</a></li>
        </ul>
      </li>
      -->
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container">
    <div class="page-main">
  <article class="markdown-body">
    <h1>中间件</h1>
    <p>在<a href="../intro/egg-and-koa.html">前面的章节</a>中，我们介绍了 egg 是基于 koa 1 实现的，所以 egg 的中间件形式和 koa 1 的中间件形式是一样的，都是基于 generator function 的<a href="../intro/egg-and-koa.html#midlleware">洋葱圈模型</a>。每次我们编写一个中间件，就相当于在洋葱外面包了一层。</p>
<h2 id="编写中间件"><a class="markdown-anchor" href="#编写中间件">#</a> 编写中间件</h2>
<h3 id="写法"><a class="markdown-anchor" href="#写法">#</a> 写法</h3>
<p>我们先来通过编写一个简单的 gzip 中间件，来看看中间件的写法。</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> isJSON = <span class="built_in">require</span>(<span class="string">'koa-is-json'</span>);</div><div class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">'zlib'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gzip</span>(<span class="params">next</span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> next;</div><div class="line"></div><div class="line">  <span class="comment">// 后续中间件执行完成后将响应体转换成 gzip</span></div><div class="line">  <span class="keyword">const</span> body = <span class="keyword">this</span>.body;</div><div class="line">  <span class="keyword">if</span>（!body) <span class="keyword">return</span>;</div><div class="line">  <span class="keyword">if</span> (isJSON(body)) body = <span class="built_in">JSON</span>.stringify(body);</div><div class="line"></div><div class="line">  <span class="comment">// 设置 gzip body，修正响应头</span></div><div class="line">  <span class="keyword">this</span>.body = zlib.createGzip().end(body);</div><div class="line">  <span class="keyword">this</span>.set(<span class="string">'Content-Encoding'</span>, <span class="string">'gzip'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，框架的中间件和 koa 的中间件写法是一模一样的，所以任何 koa 的中间件都可以直接被框架使用。</p>
<h3 id="配置"><a class="markdown-anchor" href="#配置">#</a> 配置</h3>
<p>一般来说中间件也会有自己的配置。在框架中，一个完整的中间件是包含了配置处理的。我们约定一个中间件是一个放置在 <code>app/middleware</code> 目录下的单独文件，它需要 exports 一个普通的 function，接受两个参数：</p>
<ul>
<li>options: 中间件的配置项，框架会将 <code>app.config[${middlewareName}]</code> 传递进来。</li>
<li>app: 当前应用 Application 的实例。</li>
</ul>
<p>我们将上面的 gzip 中间件做一个简单的优化，让它支持指定只有当 body 大于配置的 threshold 时才进行 gzip 压缩，我们要在 <code>app/middleware</code> 目录下新建一个文件 <code>gzip.js</code></p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> isJSON = <span class="built_in">require</span>(<span class="string">'koa-is-json'</span>);</div><div class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">'zlib'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">options, app</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>* <span class="title">gzip</span>(<span class="params">next</span>) </span>&#123;</div><div class="line">    <span class="keyword">yield</span> next;</div><div class="line"></div><div class="line">    <span class="comment">// 后续中间件执行完成后将响应体转换成 gzip</span></div><div class="line">    <span class="keyword">const</span> body = <span class="keyword">this</span>.body;</div><div class="line">    <span class="keyword">if</span>（!body) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 支持 options.threshold</span></div><div class="line">    <span class="keyword">if</span> (options.threshold &amp;&amp; <span class="keyword">this</span>.length &lt; options.threshold) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isJSON(body)) body = <span class="built_in">JSON</span>.stringify(body);</div><div class="line"></div><div class="line">    <span class="comment">// 设置 gzip body，修正响应头</span></div><div class="line">    <span class="keyword">this</span>.body = zlib.createGzip().end(body);</div><div class="line">    <span class="keyword">this</span>.set(<span class="string">'Content-Encoding'</span>, <span class="string">'gzip'</span>);</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="在应用中引入中间件"><a class="markdown-anchor" href="#在应用中引入中间件">#</a> 在应用中引入中间件</h2>
<p>在应用中，我们可以完全通过配置来引入自定义的中间件，并决定它们的顺序。</p>
<p>如果我们需要引入上面的 gzip 中间件，在 <code>config.default.js</code> 中加入下面的配置就完成了中间件的开启和配置：</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="comment">// 配置需要的中间件，数组顺序即为中间件的加载顺序</span></div><div class="line">  middleware: [ <span class="string">'gzip'</span> ],</div><div class="line"></div><div class="line">  <span class="comment">// 配置 gzip 中间件的配置</span></div><div class="line">  gzip: &#123;</div><div class="line">    <span class="attr">threshold</span>: <span class="number">1024</span>, <span class="comment">// 小于 1k 的响应体不压缩</span></div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><strong>配置项以及区分各运行环境的配置，请查看<a href="./config.html">配置</a>章节。</strong></p>
<h2 id="框架默认中间件"><a class="markdown-anchor" href="#框架默认中间件">#</a> 框架默认中间件</h2>
<p>除了应用层引入中间件之外，框架自身和其他的插件也会引入许多中间件。所有的这些自带中间件的配置项都通过在配置中修改中间件同名配置项进行修改，例如 <a href="https://github.com/eggjs/egg/tree/master/app/middleware" target="_blank" rel="external">框架自带的中间件</a>中有一个 bodyParser 中间件（框架的加载器会将文件名中的各种分隔符都修改成驼峰形式的变量名），我们想要修改 bodyParser 的配置，只需要在 <code>config/config.default.js</code> 中编写</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">bodyParser</span>: &#123;</div><div class="line">    <span class="attr">jsonLimit</span>: <span class="string">'10m'</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><strong>注意：框架和插件引入的中间件会在应用层配置的中间件之前，框架默认中间件不能被应用层中间件覆盖，如果应用层有自定义同名中间件，在启动时会报错。</strong></p>
<h2 id="router-中使用中间件"><a class="markdown-anchor" href="#router-中使用中间件">#</a> router 中使用中间件</h2>
<p>应用层定义的中间件和框架默认中间件都会被加载器加载，并挂载到 <code>app.middlewares</code> 上（注意：此处为复数，因为 <code>app.middleware</code> 在 koa 中另有用处），所以应用层定义的中间件可以不通过配置引入，而是在 router 中引入，从而只对对应的路由生效。</p>
<p>还是拿刚才的 gzip 中间件举例，当我们想直接在 router 中使用的时候，在 <code>app/router.js</code> 中就可以这样写</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> gzip = app.middlewares.gzip(&#123; <span class="attr">threshold</span>: <span class="number">1024</span> &#125;);</div><div class="line">  app.get(<span class="string">'/needgzip'</span>, gzip, app.controller.handler);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="使用-koa-的中间件"><a class="markdown-anchor" href="#使用-koa-的中间件">#</a> 使用 koa 的中间件</h2>
<p>框架兼容 koa 1.x 和 2.x 支持的所有形式的中间件，包括：</p>
<ul>
<li>generator function: <code>function* (next) {}</code></li>
<li>async function: <code>async (ctx, next) =&gt; {}</code></li>
<li>common function: <code>(ctx, next) =&gt; {}</code></li>
</ul>
<p>所有可以在 koa 中使用的中间件都可以直接在框架中使用。</p>
<p>以 <a href="https://github.com/koajs/bodyparser" target="_blank" rel="external">koa-bodyparser</a> 为例，在 koa 中使用时：</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = koa();</div><div class="line"></div><div class="line"><span class="keyword">const</span> options = &#123; <span class="attr">limit</span>: <span class="string">'10kb'</span> &#125;;</div><div class="line">app.use(bodyParser(options));</div></pre></td></tr></table></figure></p>
<p>我们按照框架的规范来在应用中引入这个 koa 的中间件：</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/middleware/body_parser.js</span></div><div class="line"></div><div class="line"><span class="comment">// koa-bodyparser 暴露的接口(`(options) =&gt; middleware`)和框架对中间件要求一致</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</div></pre></td></tr></table></figure></p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// config/config.default.js</span></div><div class="line"></div><div class="line"><span class="comment">// 所有的下划线中划线分隔的文件名都会变成驼峰</span></div><div class="line">exports.middleware = [ <span class="string">'bodyParser'</span> ];</div><div class="line">exports.bodyParser = &#123;</div><div class="line">  <span class="attr">limit</span>: <span class="string">'10kb'</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="通用配置"><a class="markdown-anchor" href="#通用配置">#</a> 通用配置</h2>
<p>无论是应用层引入的中间件还是框架自带中间件，都支持几个通用的配置项：</p>
<ul>
<li>enable：控制中间件是否开启。</li>
<li>match：设置只有符合某些规则的请求才会经过这个中间件。</li>
<li>ignore：设置符合某些规则的请求不经过这个中间件。</li>
</ul>
<h3 id="enable"><a class="markdown-anchor" href="#enable">#</a> enable</h3>
<p>如果我们的应用并不需要默认的 bodyParser 中间件来进行请求体的解析，此时我们可以通过配置 enable 为 false 来关闭它</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">bodyParser</span>: &#123;</div><div class="line">    <span class="attr">enable</span>: <span class="literal">false</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="match-ignore"><a class="markdown-anchor" href="#match-ignore">#</a> match &amp; ignore</h3>
<p>match 和 ignore 支持的参数都一样，只是作用完全相反，match 和 ignore 不允许同时配置。</p>
<p>如果我们想让 gzip 只针对 <code>/static</code> 前缀开头的 url 请求开启，我们可以配置 match 选项</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">gzip</span>: &#123;</div><div class="line">    <span class="attr">match</span>: <span class="string">'/static'</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>match 和 ignore 支持多种类型的配置方式</p>
<ol>
<li>字符串：当参数为字符串类型时，配置的是一个 url 的路径前缀，所有以配置的字符串作为前缀的 url 都会匹配上。</li>
<li>正则：当参数为正则时，直接匹配满足正则验证的 url 的路径。</li>
<li>函数：当参数为一个函数时，会将请求上下文传递给这个函数，最终取函数返回的结果（ture/false）来判断是否匹配。</li>
</ol>
<p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">gzip</span>: &#123;</div><div class="line">    match(ctx) &#123;</div><div class="line">      <span class="comment">// 只有 ios 设备才开启</span></div><div class="line">      <span class="keyword">const</span> reg = <span class="regexp">/iphone|ipad|ipod/i</span>;</div><div class="line">      <span class="keyword">return</span> reg.test(ctx.get(<span class="string">'user-agent'</span>));</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>

  </article>
  <aside id="mobileAside" class="toc">
  <div class="mobile-menu">
    <ul><li><a href="/zh-cn/intro/" alt="指南">指南</a></li><li><a href="/zh-cn/tutorials/index.html" alt="教程">教程</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="插件">插件</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="发布日志">发布日志</a></li></ul>
  </div>
  <dl><dt>新手指南</dt><dd><ul><li><a href="/zh-cn/intro/index.html">egg 是什么?</a></li><li><a href="/zh-cn/intro/egg-and-koa.html">egg 和 koa</a></li><li><a href="/zh-cn/intro/quickstart.html">快速入门</a></li></ul></dd><dt>基础功能</dt><dd><ul><li><a href="/zh-cn/basics/structure.html">目录结构</a></li><li><a href="/zh-cn/basics/env.html">运行环境</a></li><li><a href="/zh-cn/basics/config.html">配置</a></li><li><a href="/zh-cn/basics/middleware.html">中间件</a></li><li><a href="/zh-cn/basics/router.html">Router</a></li><li><a href="/zh-cn/basics/controller.html">Controller</a></li><li><a href="/zh-cn/basics/service.html">Service</a></li><li><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></dd><dt>核心功能</dt><dd><ul><li><a href="/zh-cn/core/development.html">本地开发</a></li><li><a href="/zh-cn/core/security.html">安全</a></li><li><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li><a href="/zh-cn/core/logger.html">日志</a></li><li><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li><a href="/zh-cn/core/i18n.html">国际化</a></li><li><a href="/zh-cn/core/view.html">模板渲染</a></li><li><a href="/zh-cn/core/unittest.html">单元测试</a></li></ul></dd><dt>教程</dt><dd><ul><li><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li><a href="/zh-cn/tutorials/async-function.html">Async Function</a></li></ul></dd><dt>进阶</dt><dd><ul><li><a href="/zh-cn/advanced/loader.html">Loader</a></li><li><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li><a href="/zh-cn/advanced/cluster.html">多进程模型</a></li><li><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li></ul></dd><dt>社区</dt><dd><ul><li><a href="/zh-cn/contributing.html">如何贡献</a></li><li><a href="/zh-cn/resource.html">资源</a></li><li><a href="/zh-cn/faq.html">常见问题</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');
mobileTrigger.onclick = function(e) {
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'toc';
  }
};
</script>

</div>

  </div>
</body>
</html>
